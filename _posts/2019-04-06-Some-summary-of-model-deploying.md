---
layout:     post
title:      "关于模型工程化的一些经验总结"
date:       2019-04-06 15:00:00
author:     "Hebi"
header-img: "img/ncu_sunset.jpg"
header-mask: 0.3
catalog:    true
tags:
    - 深度学习
    - 图像分类
    - 嵌入式
    - 模型部署
---

去年九月，入职一家安防企业，属于智能交通与安防领域解决方案提供商. 我所做的工作是在已有的车牌识别工程中，新增一些功能，如红外模式下正反类型判断（分类模型），遮挡车牌识别开发. 在模型开发过程中，踩了不少坑，也总结了一些小经验.

###  建立统一的评估测试集，加速模型开发进程

在模型开发的过程中，会涉及三个环境：训练环境，本地仿真环境，相机环境. 

在前期阶段，一般在训练环境与本地仿真环境中切换.

1.1. 建立统一的评估测试集的原因是：

a.确保训练环境与本地仿真环境的指标基本一致. 否则, 不管训练时，各项指标都很完美，但是不知道在本地仿真环境中，指标如何.

b.在模型迭代过程中，评价模型，加速开发进程.

1.2. 如何建立统一的评估测试集

由于用于遮挡判断的图片（下称“遮挡判断图”）是在车牌区域图上，经过一系列的传统处理后，再进行统一比例的扩边得到的，那我们就可以利用仿真工程得到，即将**直接用于**遮挡判断的图片保存下来，其中文件名中附有模型的分类结果，人工去除定位错误或者车牌不完整的图片，得到统一的评估测试集.

1.3. 如何对比仿真工程，训练工程中的模型指标

统一的评价对象：上述评估测试集

经过上述操作，基于文件名后的分类结果，我们还可以得到仿真工程的模型指标，即精确率，召回率，准确率等.

将上述评估测试集放到训练工程中，重新跑一遍，得到训练工程中模型的指标.

将仿真工程与训练工程的模型指标进行对比，即可知道指标是否存在差异.

 
### 当仿真工程与训练工程中的指标相差很大时，该如何定位原因?
   
  按部就班地进行排查

- 模型网络结构是否一致？

- 模型参数是否一致？

- 输入图片是否有特殊操作？
  
  > 将传入模型的图片保存下来，进行核对.
  
  > 刚开始，我复用了已有的类型判断CNN对遮挡判断模型进行工程化，而该CNN框架（前辈自己写的）对图片有很奇怪的字节对齐操作，这导致进入遮挡判断模型的图片不合常理：图片被压缩到上半部分，下部分为空. 而我之前未注意到这点，一直是将正常的图片传入模型进行分类.

- 图片预处理是否一致？对照训练工程中的预处理着个核查
  
  a. 归一化：减均值，除标准差，或除以255
  
  b. 通道顺序(RGB, 还是BGR)
  

### 当外场相机环境与本地环境的指标相差很大时，该如何定位原因?
  
   目前，我碰到的问题是外场相机环境与本地环境的指标存在较大的差异.
   
   在使用ncnn对遮挡判断模型进行工程化时，从外场取回2293张被判为遮挡的遮挡判断图（未经人工筛选，包含各种各样的图），放到训练工程中进行测试，只有315张被判为遮挡，**指标相差约87%**.
   之前已通过实验知，按上述方案进行模型部署，仿真环境与训练环境的指标**一致**.

   在复用类型判断CNN对遮挡判断模型进行工程化时，从外场取回185张被判为遮挡的遮挡判断图（未经人工筛选，包含各种各样的图），放到训练工程中进行测试，只有153张被判为遮挡，**指标相差17%**.
   之前已通过实验知，按上述方案进行模型部署，仿真环境与训练环境的指标**基本一致**.


   目前，还未定位到具体原因. 先暂且复用类型判断CNN对遮挡判断模型进行工程化，定位指标差异的具体原因.

   为了测试更加有说服力，将进入遮挡判断的图全部保存下来，预计其中会有被判为遮挡，也会有被判为正常的遮挡判断图，然后放到训练工程中进行测试，比较指标差异. 视情况将定位错误或者车牌不完整的图片剔除，再进行测试与比较指标.


### 关于遮挡判断模型的网络结构的选择

目前，遮挡判断模型的网络结构是3个卷积块作为特征提取网络，2个全连接层+softmax为分类模块，在模型的数据集上精确率，召回率均能达到98%以上. 但在一些极端情况下表现很差，比如过曝,光线暗, 拖影.

加入过曝，光线暗，拖影等样本后，训练集loss出现较大震荡，test acc在0.98以下.

我在考虑是否需要换一个其他的模型试一试，或者可视化易误判的feature map，或者直接拿原图进行训练（不进行数据增广）.


### ALL

目前，还是先定位到外场相机指标差距很大的原因. 

2019.04.06 17:04
